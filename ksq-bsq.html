<!doctype html>
<html lang="az">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KSQ/BSQ ‚Äî EduPlan</title>
<meta name="description" content="Sinif, f…ônn, n√∂v v…ô n√∂mr…ô √ºzr…ô KSQ/BSQ fayllarƒ±." />
<link rel="icon" href="assets/ep-favicon-180.png" type="image/png" sizes="180x180" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ---------- Tema d…ôyi≈ü…ônl…ôri ---------- */
:root{
  --bg-from:#f8fafc; --bg-to:#ffffff; --text:#0f172a; --card:#ffffff; --muted:#475569; --border:#e2e8f0;
  --tab-track:#eef2f6; --pill:#e9edf3; --pill-text:#334155;
  --panel-min-h:320px; --panel-max-h:520px; --panel-pad-top:16px; --panel-pad-bottom:16px;
}
.dark{
  --bg-from:#0b1220; --bg-to:#0a0f1a; --text:#e2e8f0; --card:#0f172a; --muted:#cbd5e1; --border:#334155;
  --tab-track:#111827; --pill:#0f172a; --pill-text:#cbd5e1;
}

/* ---------- Layout qoruyucular ---------- */
:where(html, body, main, header, footer, section){ overflow-x:clip; min-width:0; }
select, input, button{ max-width:100%; }
html::before{ content:""; position:fixed; inset:0; z-index:-1;
  background:linear-gradient(to bottom,var(--bg-from),var(--bg-to)); }
html{ background:var(--bg-to); } html.dark{ background:#0a0f1a; }
body{ min-height:100svh; color:var(--text); }
.bg-white{ background-color:var(--card)!important; }
.text-slate-600,.text-slate-500{ color:var(--muted)!important; }
.text-slate-900{ color:var(--text)!important; }
.border-slate-200{ border-color:var(--border)!important; }
.backdrop-blur.bg-white\/70{ background-color:color-mix(in srgb,var(--card) 70%,transparent)!important; }

/* ---------- Premium select ---------- */
.select-premium{
  -webkit-appearance:none; appearance:none; background:var(--card); color:var(--text);
  border:1px solid var(--border); border-radius:12px; padding:10px 42px 10px 12px;
  line-height:1.25; box-shadow:inset 0 0 0 1px color-mix(in srgb,var(--border) 35%,transparent);
  transition:border-color .18s, box-shadow .18s, transform .06s; cursor:pointer;
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
  background-repeat:no-repeat; background-position:right 12px center; background-size:16px;
}
.select-premium:hover{ border-color:color-mix(in srgb,var(--border) 55%,transparent); }
.select-premium:focus{ outline:0; border-color:transparent; transform:translateY(-1px);
  box-shadow:0 0 0 1px color-mix(in srgb,var(--border) 45%,transparent), 0 0 0 4px rgba(34,211,238,.25); }
.dark .select-premium{ background:#0f172a; box-shadow:inset 0 0 0 1px #223049, 0 1px 0 rgba(255,255,255,.04); }
.dark .select-premium:focus{ box-shadow:0 0 0 1px #2f405c, 0 0 0 4px rgba(167,139,250,.22); }
select:invalid{ color:#9aa4b2; }
.add-shadow .bg-white:hover{ box-shadow:0 6px 16px rgba(0,0,0,.12);}
.dark .add-shadow .bg-white:hover{ box-shadow:0 6px 16px rgba(255,255,255,.15);}
/* Fancy Select √ºst√ºn…ô native select g√∂r√ºnm…ôsin */
select.select-premium.fs-native{
  position:absolute; inset:0; opacity:0; pointer-events:none;
}

/* Dark rejimd…ô kontrast v…ô border d√ºz…ôldilm…ôsi */
.dark .select-premium,
.dark .fs-btn{
  background:#0f172a !important;
  color:#e5e7eb !important;
  border-color:#253046 !important;
  box-shadow: inset 0 0 0 1px #223049, 0 1px 0 rgba(255,255,255,.04) !important;
}

/* Placeholder m…ôtninin r…ôngi (Sinfi se√ßin v…ô s.) */
select:invalid,
.fs-opt.is-placeholder{ color:#9aa4b2 !important; }

/* Fancy select menyusu h…ômi≈ü…ô √ºst qatda olsun, k…ôsilm…ôsin */
.fs-menu{ z-index:70 !important; }

/* ---------- Panel & bo≈ü hal ---------- */
.panel-card{ display:grid; grid-template-rows:auto minmax(0,1fr); min-height:var(--panel-min-h); border-radius:1rem; }
.panel-card > :nth-child(2){ padding-top:var(--panel-pad-top)!important; padding-bottom:var(--panel-pad-bottom)!important; }
.empty-light{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
.empty-light .card{ width:min(520px,100%); border:1px solid var(--border); background:var(--card); border-radius:16px; text-align:center; padding:22px 18px; box-shadow:0 6px 16px rgba(0,0,0,.06);}
.empty-light .icon{ width:44px; height:44px; border-radius:9999px; display:grid; place-items:center; margin:0 auto 8px;
  background:radial-gradient(closest-side, rgba(147,51,234,.12), transparent 70%), conic-gradient(from 180deg at 50% 50%, #22d3ee33, #a78bfa33, #22d3ee33);
  border:1px solid #e9eaf0; font-size:20px; }
.empty-light .title{ font-weight:600; font-size:15px; }
.empty-light .desc{ font-size:13px; color:var(--muted); margin-top:4px; }
.empty-overlay{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; background:transparent; }
.empty-overlay .inner{ width:min(520px,100%); border:1px solid rgba(255,255,255,.22); background:rgba(2,6,23,.55);
  border-radius:16px; backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); padding:22px 18px; text-align:center; box-shadow:0 8px 22px rgba(0,0,0,.35); }
.empty-overlay .icon{ width:44px; height:44px; border-radius:9999px; display:grid; place-items:center; margin:0 auto 8px;
  background:radial-gradient(closest-side, rgba(255,255,255,.14), transparent 70%), conic-gradient(from 180deg at 50% 50%, #22d3ee33, #a78bfa33, #22d3ee33); border:1px solid rgba(255,255,255,.22); font-size:20px; }
.dark .empty-light{ display:none; }

/* ---------- Buttons ---------- */
.ep-btn-primary{ display:inline-block; width:100%; padding:.65rem 1rem; border-radius:.75rem; font-weight:600; font-size:.9rem; color:#fff;
  background:linear-gradient(90deg,#1e3a8a 0%,#4f46e5 50%,#9333ea 100%); box-shadow:0 4px 12px rgba(79,70,229,.35);
  transition:transform .15s, box-shadow .25s, filter .25s; }
.ep-btn-primary:hover{ transform:translateY(-2px); filter:brightness(1.08); box-shadow:0 6px 18px rgba(147,51,234,.45); }
.dark .ep-btn-primary{ background:linear-gradient(90deg,#312e81 0%,#4338ca 50%,#7e22ce 100%); box-shadow:0 4px 10px rgba(255,255,255,.1); }

/* ---------- Toggle (settings) ---------- */
#settings-panel .dot{
  transition: transform .2s ease, background-color .2s ease;
}
#settings-panel input:checked + span{
  background: #0ea5e9;            /* light track r…ôngi */
}
.dark #settings-panel input:checked + span{
  background: #4f46e5;            /* dark track r…ôngi */
}
#settings-panel input:checked + span .dot{
  transform: translateX(16px);    /* d√ºym…ôni saƒüa s√ºr√º≈üd√ºr */
}

.dark html, .dark body, .dark .scrollarea{ scrollbar-color:rgba(180,180,255,.25) transparent; }
::-webkit-scrollbar{ width:12px; height:12px;} ::-webkit-scrollbar-thumb{ border-radius:10px; background:rgba(100,100,100,.4);}
::-webkit-scrollbar-thumb:hover{ background:rgba(100,100,100,.6);} ::-webkit-scrollbar-track{ background:transparent; }
/* Settings popover ekrana sabitlensin v…ô h…ômi≈ü…ô √ºst qatda qalsƒ±n */
#settings-panel{
  position: fixed !important;
  z-index: 1000 !important;
  inset: auto auto auto auto; /* koordinatƒ± JS ver…ôc…ôk */
}

</style>
<!-- Adsense (modal √º√ß√ºn) -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1241199346930032" crossorigin="anonymous"></script>
</head>
<body class="min-h-screen text-slate-900 relative">
  <!-- dekor -->
  <div class="pointer-events-none absolute inset-0 -z-10 overflow-hidden">
    <div class="absolute -top-24 -right-24 h-72 w-72 rounded-full blur-3xl bg-gradient-to-tr from-indigo-200/50 to-emerald-200/50"></div>
    <div class="absolute -bottom-24 -left-24 h-72 w-72 rounded-full blur-3xl bg-gradient-to-tr from-amber-200/40 to-pink-200/40"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img id="site-logo" src="assets/ep-favicon-light.svg" class="h-9 w-9 rounded-2xl shadow-sm" alt="EduPlan" />
        <span class="font-semibold tracking-tight">EduPlan AZ</span>
      </div>
      <div class="relative">
        <button id="btn-settings" class="rounded-2xl border px-3 py-2 text-sm">‚öôÔ∏è T…ônziml…ôm…ôl…ôr</button>
        <div id="settings-panel" class="hidden w-64 rounded-2xl border border-slate-200 bg-white p-4 shadow-lg">
          <div class="flex items-center justify-between">
            <div class="text-sm">üåô Qaranlƒ±q rejim</div>
            <label class="inline-flex items-center cursor-pointer">
              <input id="dark-toggle" type="checkbox" class="sr-only">
              <span class="w-10 h-6 bg-slate-200 rounded-full relative transition">
                <span class="dot absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition"></span>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main (yalnƒ±z KSQ/BSQ) -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <section class="add-shadow">
      <div class="rounded-2xl shadow-sm transition border bg-white panel-card">
        <div class="p-4 border-b"><h3 class="font-semibold">KSQ/BSQ</h3></div>

        <div class="p-4 grid lg:grid-cols-3 gap-6 items-stretch">
          <!-- Sol filtr s√ºtunu -->
          <div class="space-y-4 overflow-visible">
            <div>
              <label class="text-sm text-slate-700 block">Sinif</label>
              <select id="grade" class="select-premium w-full mt-1"></select>
            </div>
            <div>
              <label class="text-sm text-slate-700 block">F…ônn</label>
              <select id="subject" class="select-premium w-full mt-1"></select>
            </div>
            <div>
              <label class="text-sm text-slate-700 block">N√∂v</label>
              <select id="ksqType" class="select-premium w-full mt-1"></select>
            </div>
            <div>
              <label class="text-sm text-slate-700 block">N√∂mr…ô</label>
              <select id="examIndex" class="select-premium w-full mt-1"></select>
            </div>
          </div>

          <!-- Saƒü n…ôtic…ô kartƒ± -->
          <div class="lg:col-span-2 min-w-0">
            <div id="ksq-results-card" class="relative w-full rounded-xl border border-slate-200 bg-white text-sm overflow-clip">
              <div id="ksq-count-row" class="hidden items-center justify-end mb-3 px-4 pt-4">
                <span id="ksq-count" class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600 border">0</span>
              </div>
              <div id="ksq-results" class="grid sm:grid-cols-2 gap-3 p-4"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-sm text-slate-600">
      ¬© <span id="year"></span> EduPlan AZ ¬∑ B√ºt√ºn h√ºquqlar qorunur
    </footer>
  </main>

  <!-- 15s interstitial download modal -->
  <div id="dlModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/60">
    <div class="relative w-[92%] max-w-[440px] rounded-3xl bg-[#121212] text-white p-5 shadow-2xl" id="dlCard">
      <button id="dlClose" class="absolute -right-3 -top-3 grid h-10 w-10 place-items-center rounded-full bg-white/90 text-gray-800 shadow">‚úï</button>
      <div class="mb-3 text-sm text-gray-300">Preparing your download</div>
      <div class="relative overflow-hidden rounded-2xl bg-[#1b1b1b] border border-white/10">
        <div class="w-full grid place-items-center" style="min-height:250px">
          <ins class="adsbygoogle" id="modal-ad" style="display:inline-block;width:300px;height:250px"
               data-ad-client="ca-pub-1241199346930032" data-ad-slot="4681795317"></ins>
        </div>
      </div>
      <div class="mt-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="relative h-10 w-10">
            <div id="ring" class="h-10 w-10 rounded-full" style="background:
              conic-gradient(#8b5cf6 0deg, #8b5cf6 0deg, #333 0deg, #333 360deg);"></div>
            <div class="absolute inset-0 grid place-items-center text-sm font-semibold" id="dlCount"></div>
          </div>
          <div class="text-sm text-gray-300" id="dlStatus">Please wait a few moments for the download to begin</div>
        </div>
      </div>
      <div class="mt-4 h-1 w-full overflow-hidden rounded-full bg-white/10">
        <div id="dlBar" class="h-1 bg-violet-500 w-0"></div>
      </div>
    </div>
  </div>

<script>
/* ------------------ STATE & DATA ------------------ */
const FEED_URL = "https://script.google.com/macros/s/AKfycbxnt6tDu5YJ_P_FUgobNTu_Q-2dbyZjaXSWwyjIKysTJ3UwnWZKqm0ZxoNwoyT4M0w7/exec";
const translations = {
  subjects: {
    az:'Az…ôrbaycan dili', lit:'∆èd…ôbiyyat', science:'T…ôbi…ôt', eng:'ƒ∞ngilis dili', rus:'Rus dili', math:'Riyaziyyat',
    physics:'Fizika', chemistry:'Kimya', biology:'Biologiya',
    az_history:'Az…ôrbaycan tarixi', world_history:'√úmumi tarix', geography:'Coƒürafiya',
    it:'ƒ∞nformatika', life:'H…ôyat bilgisi', tech:'Texnologiya', art:'T…ôsviri inc…ôs…ôn…ôt', music:'Musiqi',
    pe:'Fiziki t…ôrbiy…ô', premilitary:'√áaƒüƒ±rƒ±≈üaq…ôd…ôrki hazƒ±rlƒ±q'
  }
};
const subjectKeysByGrade = {
  I:['az','life','math','eng','rus','art','music','pe','tech','it'],
  II:['az','life','math','eng','rus','art','music','pe','tech','it'],
  III:['az','life','math','eng','rus','art','music','pe','tech','it'],
  IV:['az','life','math','eng','rus','art','music','pe','tech','it'],
  V:['az','lit','eng','rus','math','science','it','az_history','geography','art','music','pe','tech'],
  VI:['az','lit','eng','rus','math','physics','science','it','az_history','geography','art','music','pe','tech'],
  VII:['az','lit','eng','rus','math','physics','chemistry','biology','az_history','world_history','geography','it','pe','art','music','tech'],
  VIII:['az','lit','eng','rus','math','physics','chemistry','biology','az_history','world_history','geography','it','pe','art','music','tech'],
  IX:['az','lit','eng','rus','math','physics','chemistry','biology','az_history','world_history','geography','it','pe','art','music','tech'],
  X:['az','lit','eng','rus','math','physics','chemistry','biology','az_history','world_history','geography','it','pe','art','music','tech','premilitary'],
  XI:['az','lit','eng','rus','math','physics','chemistry','biology','az_history','world_history','geography','it','pe','art','music','tech','premilitary'],
};
const state = { grade:null, subject:null, ksqType:null, examIndex:null, catalog:[] };

const $ = s => document.querySelector(s);

/* ------------------ THEME (settings) ------------------ */
const settingsBtn = $('#btn-settings'), panel = $('#settings-panel'), darkToggle = $('#dark-toggle');
const mq = window.matchMedia('(prefers-color-scheme: dark)');
const saved = localStorage.getItem('theme');
const initialTheme = saved ? saved : (mq.matches ? 'dark' : 'light');
document.documentElement.classList.toggle('dark', initialTheme === 'dark');
darkToggle.checked = (initialTheme === 'dark');
applyThemeAssets(initialTheme);
document.addEventListener('click', e=>{ if(!panel.contains(e.target) && !settingsBtn.contains(e.target)) panel.classList.add('hidden'); });
settingsBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  panel.classList.toggle('hidden');
  if (!panel.classList.contains('hidden')) {
    placeSettingsPanel();   // a√ßƒ±lan kimi d√ºym…ônin yanƒ±na yerl…ô≈üdir
  }
});
  window.addEventListener('resize', placeSettingsPanel);
window.addEventListener('scroll', placeSettingsPanel, { passive: true });

darkToggle.addEventListener('change', e=>{
  const theme = e.target.checked ? 'dark' : 'light';
  document.documentElement.classList.toggle('dark', theme === 'dark');
  localStorage.setItem('theme', theme);
  applyThemeAssets(theme);
  refreshEmptyPlaceholders();
});
mq.addEventListener?.('change', e=>{
  if(!localStorage.getItem('theme')){
    const theme = e.matches ? 'dark' : 'light';
    document.documentElement.classList.toggle('dark', theme === 'dark');
    darkToggle.checked = (theme === 'dark');
    applyThemeAssets(theme); refreshEmptyPlaceholders();
  }
});
function applyThemeAssets(theme){
  $('#site-logo').src = theme === 'dark' ? 'assets/ep-favicon-dark.svg' : 'assets/ep-favicon-light.svg';
}
function placeSettingsPanel(){
  const btn  = document.getElementById('btn-settings');
  const pop  = document.getElementById('settings-panel');
  if(!btn || !pop || pop.classList.contains('hidden')) return;

  // D√ºym…ônin ekran koordinatlarƒ±
  const r  = btn.getBoundingClientRect();
  const gap = 8; // d√ºym…ô il…ô panel arasƒ±nda ki√ßik bo≈üluq

  // ƒ∞lkin m√∂vqe: d√ºym…ônin saƒü-altƒ±
  let left = r.right - pop.offsetWidth;
  let top  = r.bottom + gap;

  const vw = window.innerWidth;
  const vh = window.innerHeight;

  // Saƒüdan/soldan/k…ônardan da≈üarsa t…ônziml…ô
  if (left < 8) left = 8;
  if (left + pop.offsetWidth > vw - 8) left = vw - pop.offsetWidth - 8;

  // A≈üaƒüƒ± sƒ±ƒümƒ±rsa yuxarƒ±ya ‚Äúflip‚Äù
  if (top + pop.offsetHeight > vh - 8) top = r.top - pop.offsetHeight - gap;

  pop.style.left = Math.round(left) + 'px';
  pop.style.top  = Math.round(top)  + 'px';
}

/* ------------------ HELPERS ------------------ */
function option(el,v,t){ const o=document.createElement('option'); o.value=v; o.textContent=t; el.appendChild(o); }
function addPlaceholder(selectEl, label){
  const o=document.createElement('option'); o.value=""; o.textContent=label; o.disabled=true; o.selected=true; o.hidden=true;
  selectEl.appendChild(o); selectEl.required = true;
}
function subjectsFor(grade){ const keys = subjectKeysByGrade[grade] || Object.keys(translations.subjects); return keys.map(k=>translations.subjects[k]).filter(Boolean); }
function allChosenKSQ(){ return !!(state.grade && state.subject && state.ksqType && state.examIndex); }

/* ------------------ RENDER SELECTS ------------------ */
function renderSelects(){
  const grades = ['I','II','III','IV','V','VI','VII','VIII','IX','X','XI'];
  const gradeEl = $('#grade'); gradeEl.innerHTML=''; addPlaceholder(gradeEl,'Sinfi se√ßin'); grades.forEach(g=>option(gradeEl,g,g)); gradeEl.value = state.grade ?? "";
  const subjEl = $('#subject'); subjEl.innerHTML=''; addPlaceholder(subjEl,'F…ônni se√ßin'); if(state.grade){ subjectsFor(state.grade).forEach(s=>option(subjEl,s,s)); } subjEl.value = state.subject ?? "";
  const typeEl = $('#ksqType'); typeEl.innerHTML=''; addPlaceholder(typeEl,'N√∂v√º se√ßin'); option(typeEl,'KSQ','KSQ'); option(typeEl,'BSQ','BSQ'); typeEl.value = state.ksqType ?? "";
  const idxEl = $('#examIndex'); idxEl.innerHTML=''; addPlaceholder(idxEl,'N√∂mr…ôni se√ßin');
  if(state.ksqType==='KSQ'){ for(let i=1;i<=10;i++) option(idxEl,String(i),String(i)); }
  else if(state.ksqType==='BSQ'){ ['1','2'].forEach(i=>option(idxEl,i,i)); }
  idxEl.value = state.examIndex ?? ""; idxEl.disabled = !state.ksqType;
  enhanceAllFancySelects();
}

/* ------------------ PLACEHOLDER ------------------ */
function showEmpty(cardId,{icon='üóÇÔ∏è',title='',desc=''}) {
  const card = document.getElementById(cardId);
  if(!card || card.querySelector('.empty-overlay') || card.querySelector('.empty-light')) return;
  const isDark = document.documentElement.classList.contains('dark');
  card.classList.add('min-h-[320px]','md:min-h-[340px]');
  if(isDark){
    const overlay = document.createElement('div');
    overlay.className='empty-overlay';
    overlay.innerHTML=`<div class="w-full h-full grid place-items-center px-6">
      <div class="inner"><div class="icon">${icon}</div><div class="title">${title}</div><div class="desc">${desc}</div></div></div>`;
    card.appendChild(overlay);
  }else{
    const box=document.createElement('div');
    box.className='empty-light';
    box.innerHTML=`<div class="card"><div class="icon">${icon}</div><div class="title">${title}</div><div class="desc">${desc}</div></div>`;
    card.appendChild(box);
  }
}
function hideEmpty(cardId){ const c=document.getElementById(cardId); c?.querySelector('.empty-overlay')?.remove(); c?.querySelector('.empty-light')?.remove(); c?.classList.remove('min-h-[320px]','md:min-h-[340px]'); }
function refreshEmptyPlaceholders(){
  if(!allChosenKSQ()){ hideEmpty('ksq-results-card'); showEmpty('ksq-results-card',{icon:'üóÇÔ∏è',title:'Z…ôhm…ôt olmasa se√ßim edin',desc:'Sinif, f…ônn, n√∂v v…ô n√∂mr…ôni se√ßdikd…ôn sonra n…ôtic…ôl…ôr burada g√∂r√ºn…ôc…ôk.'}); }
}

/* ------------------ RESULTS ------------------ */
function buildTitle(it){ const format=(it.ext||'FILE').toUpperCase(); return `${it.grade} ¬∑ ${it.subject} ¬∑ ${it.type}-${it.index} ¬∑ ${format}`; }
function renderKSQ(){
  const wrap = $('#ksq-results'); wrap.innerHTML = '';
  const list = state.catalog.filter(it => it.type===state.ksqType && it.grade===state.grade && it.subject===state.subject && it.index===state.examIndex);
  $('#ksq-count').textContent = list.length;

  const gridEl = $('#ksq-results');
  const center = (list.length>0 && list.length<=2);
  gridEl.classList.toggle('min-h-[240px]',center);
  gridEl.classList.toggle('place-content-center',center);
  gridEl.classList.toggle('justify-items-center',center);
  if(list.length===0){ wrap.innerHTML = '<div class="rounded-lg border border-dashed border-slate-300 p-6 text-slate-500">Fayl yoxdur</div>'; return; }

  list.forEach(it=>{
    const card=document.createElement('div');
    card.className='group rounded-xl p-[1px] bg-gradient-to-br from-slate-200 to-slate-100';
    card.innerHTML=`<div class="rounded-[11px] p-4 bg-white shadow-sm group-hover:shadow-md transition">
      <div class="flex items-start gap-3">
        <div class="h-8 w-8 rounded-lg bg-slate-100 grid place-items-center">üìÑ</div>
        <div class="flex-1">
          <div class="text-sm font-medium break-words">${buildTitle(it)}</div>
          <div class="mt-1"><span class="rounded-full bg-slate-100 px-2 py-0.5 text-[10px] border">${(it.ext||'FILE').toUpperCase()}</span></div>
          <div class="mt-3">
            <a href="${it.dl}" data-download="${it.dl}" class="download-btn rounded-2xl bg-slate-900 text-white px-3 py-1.5 text-sm inline-flex items-center gap-2">‚¨áÔ∏è Y√ºkl…ô</a>
          </div>
        </div>
      </div></div>`;
    wrap.appendChild(card);
  });
}
function toggleResults(){
  const gridKSQ = $('#ksq-results'); const countRowK = $('#ksq-count-row');
  if(allChosenKSQ()){ hideEmpty('ksq-results-card'); countRowK?.classList.remove('hidden'); renderKSQ(); }
  else{ countRowK?.classList.add('hidden'); gridKSQ.innerHTML=''; showEmpty('ksq-results-card',{icon:'üóÇÔ∏è',title:'Z…ôhm…ôt olmasa se√ßim edin',desc:'Sinif, f…ônn, n√∂v v…ô n√∂mr…ôni se√ßdikd…ôn sonra n…ôtic…ôl…ôr burada g√∂r√ºn…ôc…ôk.'}); }
}

/* ------------------ FEED ------------------ */
async function loadAllFromMaterials(){
  try{
    const res = await fetch(FEED_URL,{cache:'no-store'}); const catalog = await res.json();
    state.catalog = Array.isArray(catalog)? catalog : []; toggleResults();
  }catch(e){
    if(allChosenKSQ()){ $('#ksq-results').innerHTML = `<div class="rounded-lg border border-dashed border-slate-300 p-6 text-slate-500">X…ôta: ${e.message}</div>`; }
  }
}

/* ------------------ Fancy select (native qalƒ±r, √ºst√ºnd…ô UI) ------------------ */
function enhanceFancySelect(select){
  if(select.dataset.fancyMounted==='1'){ const old=select.parentElement?.classList.contains('fs-wrap')?select.parentElement:null; if(old) old.replaceWith(select); select.dataset.fancyMounted='0'; }
  const wrap=document.createElement('div'); wrap.className='fs-wrap'; wrap.setAttribute('aria-expanded','false');
  const btn=document.createElement('button'); btn.type='button'; btn.className='fs-btn select-premium'; btn.style.paddingRight='42px';
  btn.textContent = select.options[select.selectedIndex]?.text || select.getAttribute('placeholder') || 'Se√ßin';
  const menu=document.createElement('div'); menu.className='fs-menu hidden';
  Array.from(select.options).forEach(o=>{
    const item=document.createElement('div'); item.className='fs-opt px-3 py-2 text-sm'; item.textContent=o.text;
    if(o.disabled&&o.hidden) item.classList.add('text-slate-400','italic');
    item.addEventListener('click',()=>{ Array.from(select.options).forEach(op=>op.selected=(op===o)); select.value=o.value; select.dispatchEvent(new Event('change',{bubbles:true})); btn.textContent=o.text; menu.classList.add('hidden'); wrap.setAttribute('aria-expanded','false'); });
    menu.appendChild(item);
  });
// native select formda qalsƒ±n, amma klik/fokus almasƒ±n
select.classList.add('fs-native');   // <-- sr-only YOX
  select.parentNode.insertBefore(wrap,select);
  wrap.appendChild(btn); wrap.appendChild(select); wrap.appendChild(menu);
  select.dataset.fancyMounted='1';
btn.addEventListener('click',(e)=>{
  e.preventDefault();          // <-- …ôlav…ô et
  e.stopPropagation();
  const open = !menu.classList.contains('hidden');
  document.querySelectorAll('.fs-menu').forEach(m=>m.classList.add('hidden'));
  menu.classList.toggle('hidden', open);
  wrap.setAttribute('aria-expanded', String(!open));
});
  document.addEventListener('click',()=>{ menu.classList.add('hidden'); wrap.setAttribute('aria-expanded','false'); });
}
function enhanceAllFancySelects(){ document.querySelectorAll('select.select-premium').forEach(enhanceFancySelect); }

/* ------------------ Download modal (15s) ------------------ */
(()=> {
  const MODAL=$('#dlModal'), CARD=$('#dlCard'), BTN_CLOSE=$('#dlClose'), COUNT=$('#dlCount'), RING=$('#ring'), BAR=$('#dlBar'), STATUS=$('#dlStatus');
  let t=0,timer=null,finished=false,targetUrl=null,modalAdRendered=false,adsReady=false; const DURATION=15;
  window.addEventListener('load',()=>{ adsReady=true; });
  function updateRing(){ const deg=((DURATION - t)/DURATION)*360; RING.style.background=`conic-gradient(#8b5cf6 ${deg}deg, #333 ${deg}deg 360deg)`; }
  function closeModal(){ MODAL.classList.add('hidden'); MODAL.classList.remove('flex'); if(timer) clearInterval(timer); timer=null; }
  function finish(){ if(finished) return; finished=true; closeModal(); if(!targetUrl) return;
    const a=document.createElement('a'); a.href=targetUrl; a.rel='noopener'; a.target='_self'; a.download=''; document.body.appendChild(a); a.click(); a.remove();
    requestAnimationFrame(()=>{ if(document.visibilityState!=='hidden'){ try{ window.location.assign(targetUrl); }catch{} }});
  }
  function openModal(url){
    targetUrl=url; finished=false; MODAL.classList.remove('hidden'); MODAL.classList.add('flex');
    t=DURATION; COUNT.textContent=t; STATUS.textContent='Please wait a few moments for the download to begin'; BAR.style.width='0%'; updateRing();
    if(!modalAdRendered){ modalAdRendered=true; const tryRender=()=>{ try{ (window.adsbygoogle = window.adsbygoogle || []).push({}); }catch{ setTimeout(()=>tryRender(),400);} }; adsReady?tryRender():setTimeout(()=>tryRender(),500); }
    timer=setInterval(()=>{ t--; COUNT.textContent=t>=0?t:0; const p=((DURATION - t)/DURATION)*100; BAR.style.width=Math.min(100,Math.max(0,p))+'%'; updateRing(); if(t<=0) finish(); },1000);
  }
  document.addEventListener('click', e=>{
    const a=e.target.closest('a.download-btn'); if(!a) return;
    if(e.button!==0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
    const url=a.getAttribute('data-download') || a.getAttribute('href'); if(!url) return;
    e.preventDefault(); openModal(url);
  });
  BTN_CLOSE.addEventListener('click', closeModal);
  MODAL.addEventListener('click', e=>{ if(!CARD.contains(e.target)) closeModal(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && !MODAL.classList.contains('hidden')) closeModal(); });
})();

/* ------------------ Events & init ------------------ */
document.getElementById('year').textContent = new Date().getFullYear();
renderSelects(); refreshEmptyPlaceholders(); loadAllFromMaterials();

document.getElementById('grade').addEventListener('change', e=>{ state.grade=e.target.value||null; state.subject=null; renderSelects(); toggleResults(); });
document.getElementById('subject').addEventListener('change', e=>{ state.subject=e.target.value||null; toggleResults(); });
document.getElementById('ksqType').addEventListener('change', e=>{ state.ksqType=e.target.value||null; state.examIndex=null; renderSelects(); toggleResults(); });
document.getElementById('examIndex').addEventListener('change', e=>{ state.examIndex=e.target.value||null; toggleResults(); });
</script>
</body>
</html>
